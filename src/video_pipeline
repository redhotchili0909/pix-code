from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload
from oauth2client.file import Storage
from oauth2client.client import flow_from_clientsecrets
from oauth2client.tools import run_flow
from pytube import YouTube


CLIENT_SECRETS_FILE = "credentials/pix-code.json"

SCOPES = ["https://www.googleapis.com/auth/youtube.upload"]
API_SERVICE_NAME = "youtube"
API_VERSION = "v3"


def get_authenticated_service():
    flow = flow_from_clientsecrets(CLIENT_SECRETS_FILE, scope=SCOPES)
    storage = Storage(f"{API_SERVICE_NAME}-{API_VERSION}.oauth2.json")
    credentials = storage.get()

    if credentials is None or credentials.invalid:
        credentials = run_flow(flow, storage)

    return build(API_SERVICE_NAME, API_VERSION, credentials=credentials)


def upload_video(
    youtube, file_path, title, description, category_id, keywords, privacy_status
):
    body = {
        "snippet": {
            "title": title,
            "description": description,
            "tags": keywords,
            "categoryId": category_id,
        },
        "status": {"privacyStatus": privacy_status},
    }

    insert_request = youtube.videos().insert(
        part=",".join(body.keys()),
        body=body,
        media_body=MediaFileUpload(file_path, chunksize=-1, resumable=True),
    )

    response = insert_request.execute()
    return response


def download_video(url):
    yt = YouTube(url)
    yt.streams.get_highest_resolution().download("results/downloads/")
    print("Downloaded video from YouTube")


def main():
    youtube = get_authenticated_service()
    file_path = "results/vids/frankenstein.mp4"
    title = "pix-code-test-frankenstein"
    description = "Testing for pix-code video upload"
    category_id = "22"
    keywords = ["storage", "encryption"]
    privacy_status = "unlisted"

    upload_response = upload_video(
        youtube, file_path, title, description, category_id, keywords, privacy_status
    )
    print("Uploaded video with ID:", upload_response["id"])


if __name__ == "__main__":
    main()
